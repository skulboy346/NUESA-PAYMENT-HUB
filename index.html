<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NUESA PAYMENT HUB</title>
    <!-- Site Icon -->
    <link rel="icon" href="NUESA.jpg" type="image/jpeg">
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Styles for printing the receipt */
        @media print {
            body * {
                visibility: hidden;
            }
            #receiptPreviewModal, #receiptPreviewModal * {
                visibility: visible;
            }
            #receiptPreviewModal {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                margin: 0;
                border: none;
                box-shadow: none;
                border-radius: 0;
                overflow: hidden; /* Fix for overflow */
            }
            #receiptPreviewContent {
                 box-shadow: none;
                 border: none;
            }
            #receiptModalHeader {
                display: none;
            }
        }
        /* Custom message box */
        #messageBox {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            transition: all 0.3s ease-in-out;
            opacity: 0;
            transform: translateY(20px);
            z-index: 100;
        }
        #messageBox.show {
            opacity: 1;
            transform: translateY(0);
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 md:p-8">

    <!-- Firebase SDK Scripts -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, setPersistence, inMemoryPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, collection, onSnapshot, query, getDoc, setLogLevel, serverTimestamp, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Global Variables ---
        let db, auth;
        let userId = null;
        // This is your app's unique ID for the database. You can leave this as-is.
        const appId = 'nuesa-payment-hub';
        let unsubscribePayments = null; // To store the onSnapshot unsubscribe function
        let currentPaymentIdToConfirm = null; // Store ID for confirmation modal

        // --- TODO: UPDATE FOR LIVE SITE (1/3) ---
        // Update these payment amounts with your real values.
        const PAYMENT_AMOUNTS = {
            dues: 3000,    // <-- Change this
            tshirt: 5000   // <-- Change this
        };

        // --- TODO: UPDATE FOR LIVE SITE (2/3) ---
        // Update these bank account details with your real information.
        const accountDetails = {
            dues: {
                title: "NUESA Dues Payment",
                bank: " Wema Bank",
                name: "NIGERIA UNIVERSITY EDUCATION STUDENTS ASSOCIATION (NUESA)",
                number: "0224613345",
            },
            tshirt: {
                title: "NUESA T-Shirt Payment",
                bank: "GTBank (GTCrea8)", // <-- TODO: UPDATE THIS
                name: "NUESA Social Account", // <-- TODO: UPDATE THIS
                number: "0012345678", // <-- TODO: UPDATE THIS
            }
        };

        // --- TODO: UPDATE FOR LIVE SITE (3/3) ---
        // PASTE YOUR FIREBASE CONFIGURATION HERE
        // 1. Go to your Firebase project console.
        // 2. Click the Gear icon > Project Settings.
        // 3. Scroll down to "Your apps".
        // 4. Click on the "</>" icon to see your "Web app" config.
        // 5. Copy the config object and paste it below.
        // ------------------------------------------------
        const firebaseConfig = {
            apiKey: "PASTE_YOUR_API_KEY_HERE",
            authDomain: "PASTE_YOUR_AUTH_DOMAIN_HERE",
            projectId: "PASTE_YOUR_PROJECT_ID_HERE",
            storageBucket: "PASTE_YOUR_STORAGE_BUCKET_HERE",
            messagingSenderId: "PASTE_YOUR_MESSAGING_SENDER_ID_HERE",
            appId: "PASTE_YOUR_APP_ID_HERE"
        };
        // ------------------------------------------------

        // --- DOM Elements ---
        const loadingIndicator = document.getElementById('loadingIndicator');
        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');
        const messageClose = document.getElementById('messageClose');
        const authStatus = document.getElementById('authStatus');
        const userIdDisplay = document.getElementById('userIdDisplay');

        // Payment Portal Elements
        const duesButton = document.getElementById('duesButton');
        const tshirtButton = document.getElementById('tshirtButton');
        
        // Payment History Lists
        const pendingPaymentsList = document.getElementById('pendingPaymentsList');
        const completedReceiptsList = document.getElementById('completedReceiptsList');

        // Dues Info Modal Elements
        const duesInfoModal = document.getElementById('duesInfoModal');
        const closeDuesInfoModal = document.getElementById('closeDuesInfoModal');
        const duesInfoForm = document.getElementById('duesInfoForm');

        // T-Shirt Info Modal Elements
        const tshirtInfoModal = document.getElementById('tshirtInfoModal');
        const closeTshirtInfoModal = document.getElementById('closeTshirtInfoModal');
        const tshirtInfoForm = document.getElementById('tshirtInfoForm');

        // Payment Details Modal Elements
        const paymentModal = document.getElementById('paymentModal');
        const closeModal = document.getElementById('closeModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalBank = document.getElementById('modalBank');
        const modalAccountName = document.getElementById('modalAccountName');
        const modalAccountNumber = document.getElementById('modalAccountNumber');
        const modalReferenceNote = document.getElementById('modalReferenceNote');
        const copyButton = document.getElementById('copyButton');

        // Confirm Payment Modal Elements
        const confirmPaymentModal = document.getElementById('confirmPaymentModal');
        const closeConfirmModal = document.getElementById('closeConfirmModal');
        const confirmPaymentForm = document.getElementById('confirmPaymentForm');
        const bankReferenceInput = document.getElementById('bankReference');
        
        // Receipt Preview Modal Elements
        const receiptPreviewModal = document.getElementById('receiptPreviewModal');
        const closeReceiptModal = document.getElementById('closeReceiptModal');
        const printButton = document.getElementById('printButton');
        const receiptPreview = document.getElementById('receiptPreview');


        // --- Helper Functions ---

        function showMessage(message, isError = false) {
            messageText.textContent = message;
            messageBox.classList.remove('bg-red-500', 'bg-green-500');
            messageBox.classList.add(isError ? 'bg-red-500' : 'bg-green-500');
            messageBox.classList.add('show');
            setTimeout(() => {
                messageBox.classList.remove('show');
            }, 3000);
        }

        messageClose.addEventListener('click', () => {
            messageBox.classList.remove('show');
        });

        function showLoading(show) {
            loadingIndicator.classList.toggle('hidden', !show);
        }

        function formatCurrency(amount, currency = 'NGN') {
            return new Intl.NumberFormat('en-NG', { style: 'currency', currency: currency }).format(amount);
        }
        
        function formatDate(date) {
            if (date && typeof date.toDate === 'function') {
                return date.toDate().toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            }
            if (date instanceof Date) {
                 return date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            }
            return 'N/A';
        }

        // --- Modal Control Functions ---
        
        function openModal(modalElement) {
            modalElement.classList.remove('hidden');
        }

        function closeModal(modalElement) {
            modalElement.classList.add('hidden');
        }

        // --- Firebase Functions ---

        async function initFirebase() {
            try {
                // Check if Firebase config is placeholder
                if (firebaseConfig.apiKey === "PASTE_YOUR_API_KEY_HERE") {
                    console.error("Firebase config is missing.");
                    showMessage("Application is not configured.", true);
                    authStatus.textContent = 'CONFIG ERROR';
                    authStatus.classList.add('bg-red-500');
                    return;
                }

                showLoading(true);
                
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('debug'); 

                await setPersistence(auth, inMemoryPersistence);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        authStatus.textContent = 'Authenticated';
                        authStatus.classList.replace('bg-yellow-500', 'bg-green-500');
                        userIdDisplay.textContent = `User ID: ${userId.substring(0, 8)}...`; // Shorten for display
                        
                        // Load user's payment history
                        loadPaymentHistory(userId);
                    } else {
                        userId = null;
                        authStatus.textContent = 'Authenticating...';
                        authStatus.classList.replace('bg-green-500', 'bg-yellow-500');
                        userIdDisplay.textContent = 'User ID: N/A';
                        
                        if (unsubscribePayments) {
                            unsubscribePayments();
                            unsubscribePayments = null;
                        }
                        renderPendingPayments([]);
                        renderCompletedReceipts([]);

                        try {
                            // Only use Anonymous sign-in for live site
                            await signInAnonymously(auth);
                        } catch (error) {
                            console.error("Authentication Error:", error);
                            authStatus.textContent = 'Auth Failed';
                            authStatus.classList.add('bg-red-500');
                            showMessage("Failed to authenticate.", true);
                        }
                    }
                    showLoading(false);
                });

            } catch (error) {
                console.error("Firebase Init Error:", error);
                showMessage("Error initializing application.", true);
                showLoading(false);
                authStatus.textContent = 'Init Failed';
                authStatus.classList.add('bg-red-500');
            }
        }

        /**
         * Loads and listens for payment history
         */
        function loadPaymentHistory(uid) {
            if (unsubscribePayments) {
                unsubscribePayments(); 
            }

            const paymentsPath = `artifacts/${appId}/users/${uid}/payments`;
            const paymentsCol = collection(db, paymentsPath);
            const q = query(paymentsCol); // Add orderBy('createdAt', 'desc') if you create an index

            unsubscribePayments = onSnapshot(q, (snapshot) => {
                const pending = [];
                const completed = [];
                snapshot.forEach(doc => {
                    const payment = { id: doc.id, ...doc.data() };
                    if (payment.status === 'pending') {
                        pending.push(payment);
                    } else if (payment.status === 'completed') {
                        completed.push(payment);
                    }
                });
                
                // Sort by date, newest first
                pending.sort((a, b) => b.createdAt?.toMillis() - a.createdAt?.toMillis());
                completed.sort((a, b) => b.createdAt?.toMillis() - a.createdAt?.toMillis());

                renderPendingPayments(pending);
                renderCompletedReceipts(completed);
            }, (error) => {
                console.error("Error loading payment history:", error);
                showMessage("Failed to load payment history.", true);
            });
        }

        /**
         * Renders the list of pending payments
         */
        function renderPendingPayments(payments) {
            pendingPaymentsList.innerHTML = '';
            if (payments.length === 0) {
                pendingPaymentsList.innerHTML = `<li class="text-gray-500 text-center col-span-full">No pending payments.</li>`;
                return;
            }

            payments.forEach(payment => {
                const li = document.createElement('li');
                li.className = 'bg-white p-4 rounded-lg shadow border border-yellow-300';
                li.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <!-- Logo -->
                        <img src="NUESA.jpg" onerror="this.src='https://placehold.co/40x40/3B82F6/FFFFFF?text=N'" class="rounded-full w-10 h-10 object-cover" alt="NUESA Logo">
                        <div>
                            <p class="font-semibold text-lg text-gray-800">${payment.paymentType === 'dues' ? 'NUESA Dues' : 'NUESA T-Shirt'}</p>
                            <p class="text-sm text-gray-600">${payment.fullName} (${payment.matricNo})</p>
                        </div>
                    </div>
                    <div class="mt-3 p-2 bg-yellow-100 rounded-md text-center">
                        <span class="text-xs text-yellow-800 font-medium">Use this code as reference:</span>
                        <p class="font-bold text-lg text-yellow-900 tracking-wider">${payment.uniqueCode}</p>
                    </div>
                    <button data-id="${payment.id}" class="confirm-payment-btn w-full mt-3 bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 transition-colors">
                        Confirm Payment
                    </button>
                `;
                pendingPaymentsList.appendChild(li);
            });
        }

        /**
         * Renders the list of completed receipts
         */
        function renderCompletedReceipts(receipts) {
            completedReceiptsList.innerHTML = '';
            if (receipts.length === 0) {
                completedReceiptsList.innerHTML = `<li class="text-gray-500 text-center col-span-full">No completed receipts.</li>`;
                return;
            }

            receipts.forEach(receipt => {
                const li = document.createElement('li');
                li.className = 'bg-white p-4 rounded-lg shadow hover:shadow-md transition-shadow cursor-pointer border border-green-300';
                li.setAttribute('data-id', receipt.id);
                li.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div class="flex items-center space-x-3">
                            <!-- Logo -->
                            <img src="NUESA.jpg" onerror="this.src='https://placehold.co/40x40/3B82F6/FFFFFF?text=N'" class="rounded-full w-10 h-10 object-cover" alt="NUESA Logo">
                            <div>
                                <p class="font-semibold text-blue-600">${receipt.paymentType === 'dues' ? 'NUESA Dues' : 'NUESA T-Shirt'}</p>
                                <p class="text-sm text-gray-500">Paid on: ${formatDate(receipt.createdAt)}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="font-bold text-lg text-gray-800">${formatCurrency(receipt.amount)}</p>
                        </div>
                    </div>
                    <p class="text-sm text-gray-600 mt-1 ml-12">${receipt.fullName}</p>
                `;
                completedReceiptsList.appendChild(li);
            });
        }
        
        /**
         * Saves a new pending payment to Firestore
         */
        async function savePendingPayment(paymentData) {
            if (!userId) {
                showMessage("You must be authenticated.", true);
                return null;
            }
            showLoading(true);
            try {
                const paymentsPath = `artifacts/${appId}/users/${userId}/payments`;
                const docRef = await addDoc(collection(db, paymentsPath), {
                    ...paymentData,
                    createdAt: serverTimestamp() // Use server timestamp
                });
                showMessage("Pending payment created!", false);
                return docRef;
            } catch (error) {
                console.error("Error saving pending payment: ", error);
                showMessage("Error creating payment. " + error.message, true);
                return null;
            } finally {
                showLoading(false);
            }
        }

        /**
         * Updates a payment to 'completed'
         */
        async function completePayment(paymentId, bankReference) {
             if (!userId || !paymentId) {
                showMessage("Error: Not authenticated or no payment ID.", true);
                return;
            }
            showLoading(true);
            try {
                const paymentPath = `artifacts/${appId}/users/${userId}/payments/${paymentId}`;
                const docRef = doc(db, paymentPath);
                await updateDoc(docRef, {
                    status: 'completed',
                    bankReference: bankReference,
                    completedAt: serverTimestamp()
                });
                showMessage("Payment confirmed! Receipt generated.", false);
            } catch (error) {
                 console.error("Error confirming payment: ", error);
                showMessage("Error confirming payment. " + error.message, true);
            } finally {
                showLoading(false);
            }
        }

        /**
         * Fetches and displays a single receipt
         */
        async function viewPaymentReceipt(paymentId) {
            if (!userId) {
                showMessage("You must be authenticated to view receipts.", true);
                return;
            }
            showLoading(true);
            try {
                const paymentPath = `artifacts/${appId}/users/${userId}/payments/${paymentId}`;
                const docRef = doc(db, paymentPath);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    displayReceiptPreview({ id: docSnap.id, ...docSnap.data() });
                } else {
                    showMessage("Receipt not found.", true);
                }
            } catch (error) {
                console.error("Error viewing receipt: ", error);
                showMessage("Error fetching receipt details.", true);
            }
            showLoading(false);
        }

        /**
         * Generates and displays the HTML for a receipt preview
         */
        function displayReceiptPreview(paymentData) {
            const paymentTitle = paymentData.paymentType === 'dues' ? 'NUESA Dues' : 'NUESA T-Shirt';
            
            receiptPreview.innerHTML = `
                <div class="p-8 md:p-12">
                    <div class="flex flex-col sm:flex-row justify-between items-start mb-8 space-y-4 sm:space-y-0">
                        <!-- Logo and Association Name -->
                        <div class="flex items-center space-x-4">
                            <!-- Logo -->
                            <img src="NUESA.jpg" onerror="this.src='https://placehold.co/80x80/3B82F6/FFFFFF?text=NUESA'" class="rounded-lg w-20 h-20 object-cover" alt="NUESA Logo">
                            <div>
                                <p class="text-2xl font-bold text-gray-800">NUESA</p>
                                <p class="text-gray-600 text-sm">Nigeria University<br>Education Students Association</p>
                            </div>
                        </div>
    
                        <!-- Receipt Title -->
                        <div class="text-left sm:text-right w-full sm:w-auto">
                            <h1 class="text-3xl font-bold text-gray-900">Payment Receipt</h1>
                            <p class="text-gray-500">Receipt ID: <span class="font-medium text-gray-700">${paymentData.id}</span></p>
                        </div>
                    </div>

                    <div class="border-y border-gray-200 py-8 my-8">
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-6">
                            <!-- Payer Info -->
                            <div>
                                <p class="text-sm text-gray-500 uppercase tracking-wider">Paid By</p>
                                <p class="font-semibold text-gray-800 text-lg">${paymentData.fullName || 'N/A'}</p>
                                <p class="text-gray-600">${paymentData.matricNo || 'N/A'}</p>
                            </div>
                            <!-- Department Info -->
                            <div>
                                <p class="text-sm text-gray-500 uppercase tracking-wider">Department</p>
                                <p class="font-semibold text-gray-800 text-lg">${paymentData.department || 'N/A'}</p>
                            </div>
                            <!-- Level Info -->
                            <div>
                                <p class="text-sm text-gray-500 uppercase tracking-wider">Level</p>
                                <p class="font-semibold text-gray-800 text-lg">${paymentData.level || 'N/A'}</p>
                            </div>
                            <!-- Cohort Info -->
                            <div>
                                <p class="text-sm text-gray-500 uppercase tracking-wider">Cohort</p>
                                <p class="font-semibold text-gray-800 text-lg">${paymentData.cohort || 'N/A'}</p>
                            </div>
                            <!-- Date Info -->
                            <div>
                                <p class="text-sm text-gray-500 uppercase tracking-wider">Date Paid</p>
                                <p class="font-semibold text-gray-800 text-lg">${formatDate(paymentData.completedAt || paymentData.createdAt)}</p>
                            </div>
                        </div>
                    </div>

                    <!-- Payment Details Table -->
                    <table class="w-full text-left mb-8">
                        <thead>
                            <tr class="border-b border-gray-300">
                                <th class="text-sm font-semibold text-gray-600 uppercase py-2">Description</th>
                                <th class="text-sm font-semibold text-gray-600 uppercase py-2 text-right">Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="py-4">
                                    <p class="font-semibold text-gray-800">${paymentTitle}</p>
                                    <p class="text-sm text-gray-600">Payment for 2024/2025 Session</p>
                                </td>
                                <td class="py-4 text-right font-semibold text-gray-800">${formatCurrency(paymentData.amount)}</td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr class="border-t-2 border-gray-300">
                                <td class="pt-4 text-right font-bold text-gray-600 text-lg">Total Paid</td>
                                <td class="pt-4 text-right font-bold text-gray-900 text-2xl">${formatCurrency(paymentData.amount)}</td>
                            </tr>
                        </tfoot>
                    </table>
                    
                    <!-- Footer -->
                    <div class="text-center text-sm text-gray-500 mt-12">
                        <p>Thank you for your payment!</p>
                        <p class="mt-1">Bank Reference: ${paymentData.bankReference || 'N/A'}</p>
                    </div>
                </div>
            `;
            openModal(receiptPreviewModal);
        }

        // --- Event Handlers ---
        
        // Open Dues Info Modal
        duesButton.addEventListener('click', () => {
            duesInfoForm.reset();
            openModal(duesInfoModal);
        });

        // Open T-Shirt Info Modal
        tshirtButton.addEventListener('click', () => {
            tshirtInfoForm.reset();
            openModal(tshirtInfoModal);
        });

        // Close Dues Info Modal
        closeDuesInfoModal.addEventListener('click', () => closeModal(duesInfoModal));
        
        // Close T-Shirt Info Modal
        closeTshirtInfoModal.addEventListener('click', () => closeModal(tshirtInfoModal));

        // Handle Dues Info Form Submission
        duesInfoForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(duesInfoForm);
            const fullName = formData.get('fullName').trim();
            const matricNo = formData.get('matricNo').trim();
            const department = formData.get('department');
            const level = formData.get('level');
            const cohort = formData.get('cohort').trim();

            if (!fullName || !matricNo || !department || !level || !cohort) {
                showMessage("All fields are required.", true);
                return;
            }

            const uniqueCode = `NUESA-${Math.random().toString(36).substring(2, 8).toUpperCase()}`;
            const paymentData = {
                paymentType: 'dues',
                amount: PAYMENT_AMOUNTS.dues,
                fullName,
                matricNo,
                department,
                level,
                cohort,
                status: 'pending',
                uniqueCode
            };

            const docRef = await savePendingPayment(paymentData);
            
            if (docRef) {
                // Show payment details modal
                const details = accountDetails.dues;
                modalTitle.textContent = details.title;
                modalBank.textContent = details.bank;
                modalAccountName.textContent = details.name;
                modalAccountNumber.textContent = details.number;
                modalReferenceNote.textContent = `NUESA Dues - ${fullName} - ${uniqueCode}`;
                
                closeModal(duesInfoModal);
                openModal(paymentModal);
            }
        });
        
        // Handle T-Shirt Info Form Submission
        tshirtInfoForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(tshirtInfoForm);
            const fullName = formData.get('fullName').trim();
            const matricNo = formData.get('matricNo').trim();
            const department = formData.get('department');
            const level = formData.get('level');
            const cohort = formData.get('cohort').trim();
            
            if (!fullName || !matricNo || !department || !level || !cohort) {
                showMessage("All fields are required.", true);
                return;
            }

            const uniqueCode = `TSHIRT-${Math.random().toString(36).substring(2, 8).toUpperCase()}`;
            const paymentData = {
                paymentType: 'tshirt',
                amount: PAYMENT_AMOUNTS.tshirt,
                fullName,
                matricNo,
                department: department,
                level: level,
                cohort: cohort,
                status: 'pending',
                uniqueCode
            };

            const docRef = await savePendingPayment(paymentData);
            
            if (docRef) {
                // Show payment details modal
                const details = accountDetails.tshirt;
                modalTitle.textContent = details.title;
                modalBank.textContent = details.bank;
                modalAccountName.textContent = details.name;
                modalAccountNumber.textContent = details.number;
                modalReferenceNote.textContent = `NUESA T-Shirt - ${fullName} - ${uniqueCode}`;
                
                closeModal(tshirtInfoModal);
                openModal(paymentModal);
            }
        });

        // Close Payment Details Modal
        closeModal.addEventListener('click', () => closeModal(paymentModal));

        // Copy Account Number
        copyButton.addEventListener('click', () => {
            const accountNumber = modalAccountNumber.textContent;
            
            // Create a temporary textarea to copy text
            const tempInput = document.createElement('textarea');
            tempInput.style.position = 'absolute';
            tempInput.style.left = '-9999px';
            tempInput.value = accountNumber;
            document.body.appendChild(tempInput);
            tempInput.select();
            
            try {
                document.execCommand('copy');
                showMessage('Account number copied!', false);
            } catch (err) {
                showMessage('Failed to copy account number.', true);
                console.error('Copy failed', err);
            } finally {
                document.body.removeChild(tempInput);
            }
        });

        // Handle clicks on "Confirm Payment" buttons (using event delegation)
        pendingPaymentsList.addEventListener('click', (e) => {
            if (e.target.classList.contains('confirm-payment-btn')) {
                currentPaymentIdToConfirm = e.target.getAttribute('data-id');
                bankReferenceInput.value = ''; // Clear input
                openModal(confirmPaymentModal);
            }
        });

        // Close Confirm Payment Modal
        closeConfirmModal.addEventListener('click', () => closeModal(confirmPaymentModal));

        // Handle Confirm Payment Form Submission
        confirmPaymentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const bankReference = bankReferenceInput.value.trim();
            
            if (!bankReference) {
                showMessage("Please enter your bank's transaction reference.", true);
                return;
            }
            
            if (currentPaymentIdToConfirm) {
                await completePayment(currentPaymentIdToConfirm, bankReference);
                closeModal(confirmPaymentModal);
                currentPaymentIdToConfirm = null;
            } else {
                showMessage("An error occurred. No payment selected.", true);
            }
        });

        // Handle clicks on completed receipts (using event delegation)
        completedReceiptsList.addEventListener('click', (e) => {
            const receiptItem = e.target.closest('li');
            if (receiptItem && receiptItem.hasAttribute('data-id')) {
                const paymentId = receiptItem.getAttribute('data-id');
                viewPaymentReceipt(paymentId);
            }
        });
        
        // Close Receipt Preview Modal
        closeReceiptModal.addEventListener('click', () => closeModal(receiptPreviewModal));
        
        // Print Receipt
        printButton.addEventListener('click', () => {
            window.print();
        });

        // --- Initialize the Application ---
        document.addEventListener('DOMContentLoaded', initFirebase);

    </script>

    <!-- Main Payment Portal UI -->
    <div class="w-full max-w-4xl mx-auto">
        <header class="text-center mb-8">
            <div class="flex flex-col sm:flex-row items-center justify-center sm:space-x-6 space-y-4 sm:space-y-0">
                <!-- Logo -->
                <img src="NUESA.jpg" onerror="this.src='https://placehold.co/100x100/3B82F6/FFFFFF?text=NUESA'" alt="NUESA Logo" class="rounded-full shadow-md w-24 h-24 object-cover">
                <div class="text-center sm:text-left">
                    <h1 class="text-3xl font-bold text-gray-800">NUESA</h1>
                    <p class="text-xl font-semibold text-gray-700 mt-1">NIGERIA UNIVERSITY EDUCATION STUDENTS ASSOCIATION</p>
                    <p class="text-lg text-gray-600 mt-2">Payment Portal</p>
                </div>
            </div>
            <div class="mt-6 text-xs inline-block">
                <span id="authStatus" class="px-2 py-1 text-white rounded-full bg-yellow-500 text-xs">Connecting...</span>
                <span id="userIdDisplay" class="ml-2 text-gray-500">User ID: N/A</span>
            </div>
        </header>

        <!-- Loading Indicator -->
        <div id="loadingIndicator" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="text-white text-lg">Loading...</div>
        </div>
        
        <!-- Payment Options -->
        <section class="bg-white p-6 rounded-lg shadow mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Make a New Payment</h2>
            <p class="text-gray-600 mb-6">Select the payment you want to make.</p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <button id="duesButton" class="w-full bg-blue-600 text-white font-bold py-6 px-4 rounded-lg hover:bg-blue-700 transition-colors shadow-md">
                    <span class="text-2xl">NUESA DUES</span><br>
                    <span class="font-normal text-blue-100">Click to start payment</span>
                </button>
                <button id="tshirtButton" class="w-full bg-indigo-600 text-white font-bold py-6 px-4 rounded-lg hover:bg-indigo-700 transition-colors shadow-md">
                     <span class="text-2xl">NUESA T-SHIRT</span><br>
                    <span class="font-normal text-indigo-100">Click to start payment</span>
                </button>
            </div>
        </section>

        <!-- Payment History -->
        <section>
            <h2 class="text-2xl font-bold text-gray-800 mb-4">My Payment History</h2>
            
            <!-- Pending Payments -->
            <div class="mb-8">
                <h3 class="text-xl font-semibold text-yellow-700 mb-3">Pending Payments</h3>
                <ul id="pendingPaymentsList" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Pending payments will be injected here -->
                    <li class="text-gray-500 text-center col-span-full">Loading pending payments...</li>
                </ul>
            </div>
            
            <!-- Completed Receipts -->
            <div>
                <h3 class="text-xl font-semibold text-green-700 mb-3">Completed Receipts</h3>
                <ul id="completedReceiptsList" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Completed receipts will be injected here -->
                     <li class="text-gray-500 text-center col-span-full">Loading completed receipts...</li>
                </ul>
            </div>
        </section>
    </div>

    <!-- Modals -->

    <!-- Dues Info Modal -->
    <div id="duesInfoModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-40 p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800">Pay NUESA Dues</h3>
                <button id="closeDuesInfoModal" class="text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <form id="duesInfoForm">
                <div class="space-y-4">
                    <div>
                        <label for="dues-fullName" class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                        <input type="text" id="dues-fullName" name="fullName" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label for="dues-matricNo" class="block text-sm font-medium text-gray-700 mb-1">Matric No.</label>
                        <input type="text" id="dues-matricNo" name="matricNo" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label for="dues-department" class="block text-sm font-medium text-gray-700 mb-1">Department</label>
                        <select id="dues-department" name="department" class="w-full border border-gray-300 rounded-lg px-3 py-2 bg-white focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            <option value="">Select your department...</option>
                            <option value="ULSESA">SCIENCE EDUCATION (ULSESA)</option>
                            <option value="TVESA">TECHNOLOGY AND VOCATIONAL EDUCATION (TVESA)</option>
                            <option value="HKHE">HUMAN KINETICS AND HEALTH EDUCATION (HKHE)</option>
                            <option value="SESSA">SOCIAL SCIENCES EDUCATION (SESSA)</option>
                            <option value="EMSA">EDUCATIONAL MANAGEMENT (EMSA)</option>
                            <option value="EFSA">EDUCATIONAL FOUNDATION (EFSA)</option>
                            <option value="AESA">ART EDUCATION (AESA)</option>
                            <option value_="">ADULT EDUCATION (NAAES)</option>
                        </select>
                    </div>
                    <div>
                        <label for="dues-level" class="block text-sm font-medium text-gray-700 mb-1">Level</label>
                        <select id="dues-level" name="level" class="w-full border border-gray-300 rounded-lg px-3 py-2 bg-white focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            <option value="">Select your level...</option>
                            <option value="100">100 Level</option>
                            <option value="200">200 Level</option>
                            <option value="300">300 Level</option>
                            <option value="400">400 Level</option>
                        </select>
                    </div>
                    <div>
                        <label for="dues-cohort" class="block text-sm font-medium text-gray-700 mb-1">Cohort (e.g., 2021/2022)</label>
                        <input type="text" id="dues-cohort" name="cohort" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" required placeholder="Your admission year">
                    </div>
                </div>
                <button type="submit" class="w-full mt-6 bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">
                    Continue to Payment
                </button>
            </form>
        </div>
    </div>
    
    <!-- T-Shirt Info Modal -->
    <div id="tshirtInfoModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-40 p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800">Pay for NUESA T-Shirt</h3>
                <button id="closeTshirtInfoModal" class="text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <form id="tshirtInfoForm">
                <div class="space-y-4">
                    <div>
                        <label for="tshirt-fullName" class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                        <input type="text" id="tshirt-fullName" name="fullName" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label for="tshirt-matricNo" class="block text-sm font-medium text-gray-700 mb-1">Matric No.</label>
                        <input type="text" id="tshirt-matricNo" name="matricNo" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label for="tshirt-department" class="block text-sm font-medium text-gray-700 mb-1">Department</label>
                        <select id="tshirt-department" name="department" class="w-full border border-gray-300 rounded-lg px-3 py-2 bg-white focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            <option value="">Select your department...</option>
                            <option value="ULSESA">SCIENCE EDUCATION (ULSESA)</option>
                            <option value="TVESA">TECHNOLOGY AND VOCATIONAL EDUCATION (TVESA)</option>
                            <option value="HKHE">HUMAN KINETICS AND HEALTH EDUCATION (HKHE)</option>
                            <option value="SESSA">SOCIAL SCIENCES EDUCATION (SESSA)</option>
                            <option value="EMSA">EDUCATIONAL MANAGEMENT (EMSA)</option>
                            <option value="EFSA">EDUCATIONAL FOUNDATION (EFSA)</option>
                            <option value="AESA">ART EDUCATION (AESA)</option>
                            <option value="NAAES">ADULT EDUCATION (NAAES)</option>
                        </select>
                    </div>
                    <div>
                        <label for="tshirt-level" class="block text-sm font-medium text-gray-700 mb-1">Level</label>
                        <select id="tshirt-level" name="level" class="w-full border border-gray-300 rounded-lg px-3 py-2 bg-white focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            <option value="">Select your level...</option>
                            <option value="100">100 Level</option>
                            <option value="200">200 Level</option>
                            <option value="300">300 Level</option>
                            <option value="400">400 Level</option>
                        </select>
                    </div>
                    <div>
                        <label for="tshirt-cohort" class="block text-sm font-medium text-gray-700 mb-1">Cohort (e.g., 2021/2022)</label>
                        <input type="text" id="tshirt-cohort" name="cohort" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" required placeholder="Your admission year">
                    </div>
                </div>
                <button type="submit" class="w-full mt-6 bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors">
                    Continue to Payment
                </button>
            </form>
        </div>
    </div>

    <!-- Payment Details Modal -->
    <div id="paymentModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-40 p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modalTitle" class="text-xl font-bold text-gray-800">Payment Details</h3>
                <button id="closeModal" class="text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <p class="text-gray-600 mb-4">Please make your transfer to the account below. A pending payment has been created for you.</p>
            <div class="bg-gray-100 p-4 rounded-lg space-y-3">
                <div>
                    <span class="text-sm font-medium text-gray-500">Bank:</span>
                    <p id="modalBank" class="text-lg font-semibold text-gray-800">First Bank</p>
                </div>
                <div>
                    <span class="text-sm font-medium text-gray-500">Account Name:</span>
                    <p id="modalAccountName" class="text-lg font-semibold text-gray-800">NUESA National Dues Account</p>
                </div>
                <div>
                    <span class="text-sm font-medium text-gray-500">Account Number:</span>
                    <div class="flex justify-between items-center">
                        <p id="modalAccountNumber" class="text-2xl font-bold text-blue-600 tracking-wider">2001234567</p>
                        <button id="copyButton" class="text-sm bg-blue-100 text-blue-700 px-3 py-1 rounded-md hover:bg-blue-200">Copy</button>
                    </div>
                </div>
            </div>
            <div class="mt-4 p-3 bg-red-100 border border-red-300 rounded-lg">
                <p class="text-red-800 font-semibold">Important!</p>
                <p class="text-red-700 text-sm">You MUST use the unique code generated for you as the reference/narration for your bank transfer.</p>
                <p id="modalReferenceNote" class="text-red-700 text-sm mt-1"></p>
            </div>
            <p class="text-gray-600 mt-4 text-sm">After paying, return to this site and click "Confirm Payment" in the "Pending Payments" section.</p>
        </div>
    </div>

    <!-- Confirm Payment Modal -->
    <div id="confirmPaymentModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-40 p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800">Confirm Your Payment</h3>
                <button id="closeConfirmModal" class="text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <form id="confirmPaymentForm">
                <div>
                    <label for="bankReference" class="block text-sm font-medium text-gray-700 mb-1">Bank Transaction Reference</label>
                    <input type="text" id="bankReference" name="bankReference" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" required placeholder="e.g., 987654321_FT">
                    <p class="text-xs text-gray-500 mt-1">Enter the reference code or description from your bank's successful transaction alert.</p>
                </div>
                <button type="submit" class="w-full mt-6 bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 transition-colors">
                    Confirm and Generate Receipt
                </button>
            </form>
        </div>
    </div>
    
    <!-- Receipt Preview Modal -->
    <div id="receiptPreviewModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-40 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col">
            <!-- Modal Header -->
            <div id="receiptModalHeader" class="flex justify-between items-center p-4 border-b border-gray-200">
                <h3 class="text-xl font-bold text-gray-800">Payment Receipt</h3>
                <div>
                    <button id="printButton" class="text-sm bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 mr-2">
                        Print Receipt
                    </button>
                    <button id="closeReceiptModal" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
                </div>
            </div>
            <!-- Receipt Content (Scrollable) -->
            <div id="receiptPreviewContent" class="overflow-y-auto">
                <div id="receiptPreview" class="bg-white">
                    <!-- Receipt content will be injected here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Custom Message Box -->
    <div id="messageBox" class="p-4 rounded-lg text-white shadow-lg max-w-xs">
        <div class="flex justify-between items-center">
            <span id="messageText">Default Message</span>
            <button id="messageClose" class="ml-4 font-bold">&times;</button>
        </div>
    </div>
</body>
</html>